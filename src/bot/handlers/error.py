"""–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /error ‚Äî —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫.

–≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –ù–ê–ú–ï–†–ï–ù–ù–û –≤—ã–∑—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–≥–æ, —á—Ç–æ:
- –û—à–∏–±–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
- –°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞/–∞–ª–µ—Ä—Ç–∏–Ω–≥–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ

–í–ê–ñ–ù–û: –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¢–û–õ–¨–ö–û –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ—Ç–ª–∞–¥–∫–∏.
–í production —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –Ω–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤).
"""

from aiogram import Router
from aiogram.filters import Command
from aiogram.types import BotCommand, Message

from src.core.exceptions import DebugError
from src.utils.i18n import Localization
from src.utils.logging import get_logger

# –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî –ù–ï –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –º–µ–Ω—é –±–æ—Ç–∞ (—Å–ª—É–∂–µ–±–Ω–∞—è)
# –û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏
COMMAND = BotCommand(command="error", description="üî¥ –¢–µ—Å—Ç–æ–≤–∞—è –æ—à–∏–±–∫–∞")

router = Router(name="error")
logger = get_logger(__name__)


@router.message(Command(COMMAND))
async def cmd_error(message: Message, l10n: Localization) -> None:
    """–ù–∞–º–µ—Ä–µ–Ω–Ω–æ –≤—ã–∑–≤–∞—Ç—å –æ—à–∏–±–∫—É –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.

    –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞:
    1. –õ–æ–≥–∏—Ä—É–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–º, –∫—Ç–æ –≤—ã–∑–≤–∞–ª —Ç–µ—Å—Ç–æ–≤—É—é –æ—à–∏–±–∫—É
    2. –í—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç DebugError –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
    3. –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ª–æ–≤–∏—Ç—Å—è, –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ logger.exception()
    4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ

    Args:
        message: –í—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ–º–∞–Ω–¥–æ–π /error.
        l10n: –û–±—ä–µ–∫—Ç –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤.
    """
    user_id = message.from_user.id if message.from_user else 0
    username = message.from_user.username if message.from_user else "unknown"

    logger.info(
        "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–∑–≤–∞–ª —Ç–µ—Å—Ç–æ–≤—É—é –æ—à–∏–±–∫—É: user_id=%d, username=%s",
        user_id,
        username,
    )

    try:
        # –ù–∞–º–µ—Ä–µ–Ω–Ω–æ –≤—ã–∑—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
        raise DebugError(
            f"–¢–µ—Å—Ç–æ–≤–∞—è –æ—à–∏–±–∫–∞ –≤—ã–∑–≤–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {username} (id={user_id})"
        )
    except DebugError:
        # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É —Å –ø–æ–ª–Ω—ã–º traceback —á–µ—Ä–µ–∑ logger.exception()
        # –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —É–≤–∏–¥–µ—Ç—å –æ—à–∏–±–∫—É –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –∏ —Å–∏—Å—Ç–µ–º–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
        logger.exception(
            "–¢–µ—Å—Ç–æ–≤–∞—è –æ—à–∏–±–∫–∞: user_id=%d, username=%s",
            user_id,
            username,
        )

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        await message.answer(l10n.get("error_test_triggered"))
