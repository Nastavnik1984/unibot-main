"""–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /generate ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–ø–∏—Å–∞–Ω–∏–π —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤.

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∫–æ–º–∞–Ω–¥—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–¥–∞—é—â–∏—Ö –æ–ø–∏—Å–∞–Ω–∏–π —Ç–æ–≤–∞—Ä–æ–≤:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–µ
- GPT-4o Mini –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤
- –û–ø–∏—Å–∞–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è Wildberries, Ozon, Amazon –∏ –¥—Ä—É–≥–∏—Ö –ø–ª–æ—â–∞–¥–æ–∫

–ü—Ä–æ–º–ø—Ç –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ –ª—É—á—à–∏—Ö –ø—Ä–∞–∫—Ç–∏–∫–∞—Ö –∫–æ–ø–∏—Ä–∞–π—Ç–∏–Ω–≥–∞ –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤:
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (–∑–∞–≥–æ–ª–æ–≤–æ–∫, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏, –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞)
- SEO-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å –∫–ª—é—á–µ–≤—ã–º–∏ —Å–ª–æ–≤–∞–º–∏
- –ü—Ä–æ–¥–∞—é—â–∏–π —Ç–µ–∫—Å—Ç —Å —Ñ–æ–∫—É—Å–æ–º –Ω–∞ –≤—ã–≥–æ–¥—ã –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
- Bullet-points –¥–ª—è —Å–∫–∞–Ω–∏—Ä—É–µ–º–æ—Å—Ç–∏
"""

from collections.abc import Callable
from contextlib import AbstractAsyncContextManager

from aiogram import F, Router
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from aiogram.types import BotCommand, Message
from sqlalchemy.ext.asyncio import AsyncSession

from src.bot.states.generate import GenerateStates
from src.db.base import DatabaseSession
from src.db.repositories import UserRepository
from src.providers.ai.base import GenerationType
from src.services.ai_service import AIService, create_ai_service
from src.services.generation import ChatGenerationService
from src.utils import send_chat_action, send_long_message
from src.utils.i18n import Localization
from src.utils.logging import get_logger

# –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –º–µ–Ω—é –±–æ—Ç–∞
COMMAND = BotCommand(command="generate", description="üìù –û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞")

# –†–æ—É—Ç–µ—Ä –¥–ª—è –∫–æ–º–∞–Ω–¥—ã /generate
router = Router(name="generate")
logger = get_logger(__name__)

# –ö–ª—é—á –º–æ–¥–µ–ª–∏ GPT-4o Mini –∏–∑ config.yaml
MODEL_KEY = "gpt-4o-mini"

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–ø–∏—Å–∞–Ω–∏–π —Ç–æ–≤–∞—Ä–æ–≤
# –û—Å–Ω–æ–≤–∞–Ω –Ω–∞ –ª—É—á—à–∏—Ö –ø—Ä–∞–∫—Ç–∏–∫–∞—Ö –∫–æ–ø–∏—Ä–∞–π—Ç–∏–Ω–≥–∞ –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤
MARKETPLACE_SYSTEM_PROMPT = """\
–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤ —Å 10-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø—Ä–æ–¥–∞—é—â–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ:
1. –ü—Ä–∏–≤–ª–µ–∫–∞—é—Ç –≤–Ω–∏–º–∞–Ω–∏–µ –∏ –≤—ã–∑—ã–≤–∞—é—Ç –∂–µ–ª–∞–Ω–∏–µ –∫—É–ø–∏—Ç—å
2. –°–æ–¥–µ—Ä–∂–∞—Ç SEO-–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
3. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è –ª—ë–≥–∫–æ–≥–æ —á—Ç–µ–Ω–∏—è (bullet-points)
4. –ü–æ–¥—á—ë—Ä–∫–∏–≤–∞—é—Ç –≤—ã–≥–æ–¥—ã –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏

–ü–†–ê–í–ò–õ–ê –°–û–ó–î–ê–ù–ò–Ø –û–ü–ò–°–ê–ù–ò–Ø:

üìå –ó–ê–ì–û–õ–û–í–û–ö:
- –Å–º–∫–∏–π, —Ü–µ–ø–ª—è—é—â–∏–π, —Å–æ–¥–µ—Ä–∂–∏—Ç –≥–ª–∞–≤–Ω–æ–µ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ
- –î–æ 80 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
- –í–∫–ª—é—á–∞–µ—Ç 1-2 –≥–ª–∞–≤–Ω—ã—Ö –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞

üìå –ö–†–ê–¢–ö–û–ï –û–ü–ò–°–ê–ù–ò–ï (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è):
- –ì–ª–∞–≤–Ω–∞—è –≤—ã–≥–æ–¥–∞ —Ç–æ–≤–∞—Ä–∞ –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
- –î–ª—è –∫–æ–≥–æ —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä –∏ –∫–∞–∫—É—é –ø—Ä–æ–±–ª–µ–º—É —Ä–µ—à–∞–µ—Ç
- –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä

üìå –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò (bullet-points):
- 5-8 –∫–ª—é—á–µ–≤—ã—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
- –§–æ—Ä–º–∞—Ç: "‚úì [–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞]: [–ó–Ω–∞—á–µ–Ω–∏–µ + –≤—ã–≥–æ–¥–∞]"
- –ù–∞—á–∏–Ω–∞–π —Å —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è

üìå –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê (bullet-points):
- 4-6 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤
- –§–æ—Ä–º–∞—Ç: "‚Ä¢ [–í—ã–≥–æ–¥–∞ –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è]"
- –û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å "–ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –º–µ–Ω—è?"

üìå –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø:
- –°–ø–æ—Å–æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ)
- –î–ª—è –∫–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∏—Ç / –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç
- –° —á–µ–º —Å–æ—á–µ—Ç–∞–µ—Ç—Å—è / –∫–æ–º–ø–ª–µ–∫—Ç—É–µ—Ç—Å—è

üìå –ü–†–ò–ó–´–í –ö –î–ï–ô–°–¢–í–ò–Æ:
- –ú–æ—Ç–∏–≤–∏—Ä—É—é—â–µ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
- –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏ –∏–ª–∏ —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω–æ—Å—Ç–∏

–ó–ê–ü–†–ï–©–ï–ù–û:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω—ã–µ —Å—Ç–µ–ø–µ–Ω–∏ –±–µ–∑ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤ ("–ª—É—á—à–∏–π", "—É–Ω–∏–∫–∞–ª—å–Ω—ã–π")
- –ü–∏—Å–∞—Ç—å "–≤–æ–¥—è–Ω–∏—Å—Ç—ã–π" —Ç–µ–∫—Å—Ç –±–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∏
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–Ω—Ü–µ–ª—è—Ä–∏–∑–º—ã –∏ —à—Ç–∞–º–ø—ã
- –î–µ–ª–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–º (–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ 1000-2000 —Å–∏–º–≤–æ–ª–æ–≤)

–û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ."""

# –ü—Ä–æ–º–ø—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–ø–∏—Å–∞–Ω–∏—è
USER_PROMPT_TEMPLATE = """–°–æ–∑–¥–∞–π –ø—Ä–æ–¥–∞—é—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞.

–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –¢–û–í–ê–†–ï:
{product_info}

–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ –≤—Å–µ–º –ø—Ä–∞–≤–∏–ª–∞–º. \
–ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è."""


async def _send_ai_response(message: Message, content: str) -> None:
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç AI –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å typing indicator –∏ —Ä–∞–∑–±–∏–µ–Ω–∏–µ–º –Ω–∞ —á–∞—Å—Ç–∏."""
    await send_chat_action(message, GenerationType.CHAT)
    await send_long_message(message, content)


@router.message(Command(COMMAND))
async def cmd_generate(
    message: Message,
    state: FSMContext,
    l10n: Localization,
    ai_service: AIService | None = None,
) -> None:
    """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ–º–∞–Ω–¥—É /generate ‚Äî –Ω–∞—á–∞—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –æ–ø–∏—Å–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞.

    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏ GPT-4o Mini –∏ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–≤–∞—Ä–µ.

    Args:
        message: –°–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ–º–∞–Ω–¥–æ–π /generate.
        state: FSM –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º.
        l10n: –û–±—ä–µ–∫—Ç –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤.
        ai_service: AI-—Å–µ—Ä–≤–∏—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –º–æ–¥–µ–ª–∏ (DI –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è).
    """
    if not message.from_user:
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏ GPT-4o Mini
    if ai_service is None:
        ai_service = create_ai_service()

    available_models = ai_service.get_available_models()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–æ–¥–µ–ª—å GPT-4o Mini –¥–æ—Å—Ç—É–ø–Ω–∞
    if MODEL_KEY not in available_models:
        await message.answer(l10n.get("generate_model_not_available"))
        logger.warning(
            "–ú–æ–¥–µ–ª—å %s –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è %d (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ API-–∫–ª—é—á–∏ RouterAI)",
            MODEL_KEY,
            message.from_user.id,
        )
        return

    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–æ–∂–∏–¥–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–≤–∞—Ä–µ"
    await state.set_state(GenerateStates.waiting_for_product_info)

    await message.answer(l10n.get("generate_enter_product_info"))

    logger.info(
        "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å %d –Ω–∞—á–∞–ª –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –æ–ø–∏—Å–∞–Ω–∏—è /generate",
        message.from_user.id,
    )


@router.message(
    GenerateStates.waiting_for_product_info, F.text, ~F.text.startswith("/")
)
async def handle_product_info(
    message: Message,
    state: FSMContext,
    l10n: Localization,
    ai_service: AIService | None = None,
    session_factory: Callable[
        [], AbstractAsyncContextManager[AsyncSession]
    ] = DatabaseSession,
) -> None:
    """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–µ –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ.

    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç ChatGenerationService –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å –º–æ–¥–µ–ª—å—é GPT-4o Mini.
    –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–¥–∞—é—â–∏—Ö –æ–ø–∏—Å–∞–Ω–∏–π.

    Args:
        message: –¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç–æ–≤–∞—Ä–µ.
        state: FSM –∫–æ–Ω—Ç–µ–∫—Å—Ç.
        l10n: –û–±—ä–µ–∫—Ç –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤.
        ai_service: AI-—Å–µ—Ä–≤–∏—Å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (DI –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è).
        session_factory: –§–∞–±—Ä–∏–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–π –ë–î (DI –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è).
    """
    if not message.from_user or not message.text:
        return

    product_info = message.text.strip()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–ª–∏–Ω—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    if len(product_info) < 10:
        await message.answer(l10n.get("generate_info_too_short"))
        return

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —á—Ç–æ –∏–¥—ë—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞
    processing_msg = await message.answer(l10n.get("generate_processing"))

    async with session_factory() as session:
        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
        user_repo = UserRepository(session)
        user = await user_repo.get_by_telegram_id(message.from_user.id)
        if not user:
            await processing_msg.edit_text(l10n.get("error_user_not_found"))
            await state.clear()
            return

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è AI
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∫–æ–ø–∏—Ä–∞–π—Ç–∏–Ω–≥–∞ + –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–µ
        user_prompt = USER_PROMPT_TEMPLATE.format(product_info=product_info)
        messages_for_ai = [
            {"role": "system", "content": MARKETPLACE_SYSTEM_PROMPT},
            {"role": "user", "content": user_prompt},
        ]

        # –°–æ–∑–¥–∞—ë–º —Å–µ—Ä–≤–∏—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        generation_service = ChatGenerationService(session, ai_service=ai_service)

        result = await generation_service.execute(
            telegram_user_id=message.from_user.id,
            model_key=MODEL_KEY,
            processing_msg=processing_msg,
            l10n=l10n,
            messages=messages_for_ai,
            user_id=user.id,
        )

        # –ï—Å–ª–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å, —Å–µ—Ä–≤–∏—Å —É–∂–µ –ø–æ–∫–∞–∑–∞–ª –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        if not result.success:
            await state.clear()
            return

        # –í—ã—Ö–æ–¥–∏–º –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è FSM
        await state.clear()

        # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–ì–µ–Ω–µ—Ä–∏—Ä—É—é –æ–ø–∏—Å–∞–Ω–∏–µ..." –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        await processing_msg.delete()
        await _send_ai_response(message, result.content)

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        await message.answer(l10n.get("generate_completed"))

        logger.info(
            "–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: user_id=%d, –¥–ª–∏–Ω–∞=%d",
            message.from_user.id,
            len(result.content),
        )

