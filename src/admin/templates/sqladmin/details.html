{% extends "sqladmin/layout.html" %}
{% block content %}
<div class="col-12">
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">
        {% for pk in model_view.pk_columns -%}
        {{ pk.name }}
        {%- if not loop.last %};{% endif -%}
        {% endfor %}: {{ get_object_identifier(model) }}</h3>
    </div>
    <div class="card-body border-bottom py-3">
      <div class="table-responsive">
        <table class="table card-table table-vcenter text-nowrap table-hover table-bordered">
          <thead>
            <tr>
              <th class="w-1">Поле</th>
              <th class="w-1">Значение</th>
            </tr>
          </thead>
          <tbody>
            {% for name in model_view._details_prop_names %}
            {% set label = model_view._column_labels.get(name, name) %}
            <tr>
              <td>{{ label }}</td>
              {% set value, formatted_value = model_view.get_detail_value(model, name) %}
              {% if name in model_view._relation_names %}
              {% if is_list( value ) %}
              <td>
                {% for elem, formatted_elem in zip(value, formatted_value) %}
                  {% if model_view.show_compact_lists %}
                    <a href="{{ model_view._build_url_for('admin:details', request, elem) }}">({{ formatted_elem }})</a>
                  {% else %}
                    <a href="{{ model_view._build_url_for('admin:details', request, elem) }}">{{ formatted_elem }}</a><br/>
                  {% endif %}
                {% endfor %}
              </td>
              {% else %}
              <td><a href="{{ model_view._url_for_details_with_prop(request, model, name) }}">{{ formatted_value }}</a>
              </td>
              {% endif %}
              {% else %}
              <td>{{ formatted_value }}</td>
              {% endif %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="card-footer">
        <div class="d-flex flex-wrap gap-2 align-items-center">
          {# Кнопка назад #}
          <a href="{{ url_for('admin:list', identity=model_view.identity) }}" class="btn btn-outline-secondary">
            Назад
          </a>

          {# Кнопка редактирования #}
          {% if model_view.can_edit %}
          <a href="{{ model_view._build_url_for('admin:edit', request, model) }}" class="btn btn-primary">
            Редактировать
          </a>
          {% endif %}

          {# Кастомные действия #}
          {% for custom_action, label in model_view._custom_actions_in_detail.items() %}
            {# Условное отображение кнопок для рассылок #}
            {% if model_view.identity == 'broadcast' %}
              {% set status = model.status.value %}
              {% set show_button = true %}

              {# Запустить - только для DRAFT/PAUSED #}
              {% if custom_action == 'start_broadcast' and status not in ['DRAFT', 'PAUSED'] %}
                {% set show_button = false %}
              {% endif %}

              {# Приостановить - только для RUNNING #}
              {% if custom_action == 'pause_broadcast' and status != 'RUNNING' %}
                {% set show_button = false %}
              {% endif %}

              {# Отменить - только для DRAFT/PENDING/RUNNING/PAUSED #}
              {% if custom_action == 'cancel_broadcast' and status not in ['DRAFT', 'PENDING', 'RUNNING', 'PAUSED'] %}
                {% set show_button = false %}
              {% endif %}

              {% if show_button %}
                {# Определяем цвет кнопки в зависимости от действия #}
                {% set btn_class = 'btn-secondary' %}
                {% if custom_action == 'start_broadcast' %}
                  {% set btn_class = 'btn-success' %}
                {% elif custom_action == 'pause_broadcast' %}
                  {% set btn_class = 'btn-warning' %}
                {% elif custom_action == 'cancel_broadcast' %}
                  {% set btn_class = 'btn-outline-danger' %}
                {% elif custom_action == 'test_broadcast' %}
                  {% set btn_class = 'btn-info' %}
                {% elif custom_action == 'count_recipients' %}
                  {% set btn_class = 'btn-outline-primary' %}
                {% endif %}

                {% if custom_action in model_view._custom_actions_confirmation %}
                <a href="#" class="btn {{ btn_class }}" data-bs-toggle="modal"
                  data-bs-target="#modal-confirmation-{{ custom_action }}">
                  {{ label }}
                </a>
                {% else %}
                <a href="{{ model_view._url_for_action(request, custom_action) }}?pks={{ get_object_identifier(model) }}"
                  class="btn {{ btn_class }}">
                  {{ label }}
                </a>
                {% endif %}
              {% endif %}
            {% else %}
              {# Стандартное поведение для других моделей #}
              {% if custom_action in model_view._custom_actions_confirmation %}
              <a href="#" class="btn btn-secondary" data-bs-toggle="modal"
                data-bs-target="#modal-confirmation-{{ custom_action }}">
                {{ label }}
              </a>
              {% else %}
              <a href="{{ model_view._url_for_action(request, custom_action) }}?pks={{ get_object_identifier(model) }}"
                class="btn btn-secondary">
                {{ label }}
              </a>
              {% endif %}
            {% endif %}
          {% endfor %}

          {# Кнопка удаления в конце как опасное действие #}
          {% if model_view.can_delete %}
          <a href="#" data-name="{{ model_view.name }}" data-pk="{{ get_object_identifier(model) }}"
            data-url="{{ model_view._url_for_delete(request, model) }}" data-bs-toggle="modal"
            data-bs-target="#modal-delete" class="btn btn-danger ms-auto">
            Удалить
          </a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% if model_view.can_delete %}
{% include 'sqladmin/modals/delete.html' %}
{% endif %}

{% for custom_action in model_view._custom_actions_in_detail %}
{% if custom_action in model_view._custom_actions_confirmation %}
{% with confirmation_message = model_view._custom_actions_confirmation[custom_action], custom_action=custom_action,
url=model_view._url_for_action(request, custom_action) + '?pks=' + (get_object_identifier(model) | string) %}
{% include 'sqladmin/modals/details_action_confirmation.html' %}
{% endwith %}
{% endif %}
{% endfor %}

{# Авто-обновление для активных рассылок #}
{% if model_view.identity == 'broadcast' and model.status.value == 'RUNNING' %}
<script>
// Автообновление страницы каждые 5 секунд для отслеживания прогресса
(function() {
    var refreshInterval = 5000; // 5 секунд
    var countdown = refreshInterval / 1000;

    // Показываем индикатор обновления
    var indicator = document.createElement('div');
    indicator.className = 'alert alert-info d-flex align-items-center mt-3';
    indicator.innerHTML = '<i class="fa fa-sync-alt me-2"></i> Рассылка выполняется. Обновление через <span id="refresh-countdown">' + countdown + '</span> сек...';
    document.querySelector('.card').appendChild(indicator);

    // Обратный отсчёт
    var countdownEl = document.getElementById('refresh-countdown');
    setInterval(function() {
        countdown--;
        if (countdown > 0 && countdownEl) {
            countdownEl.textContent = countdown;
        }
    }, 1000);

    // Обновление страницы
    setTimeout(function() {
        // Сохраняем позицию скролла
        sessionStorage.setItem('scrollPos', window.scrollY);
        location.reload();
    }, refreshInterval);

    // Восстанавливаем позицию скролла
    var scrollPos = sessionStorage.getItem('scrollPos');
    if (scrollPos) {
        window.scrollTo(0, parseInt(scrollPos));
        sessionStorage.removeItem('scrollPos');
    }
})();
</script>
{% endif %}

{% endblock %}
