#!/bin/bash
# ==============================================================================
# ENTRYPOINT –î–õ–Ø –î–ï–ü–õ–û–Ø –ù–ê AMVERA
# ==============================================================================
#
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Å—Ç–∞—Ä—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–∞ Amvera.
# –í—ã–ø–æ–ª–Ω—è–µ—Ç —Ç—Ä–∏ —ç—Ç–∞–ø–∞:
#   1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ ‚Äî –ø—ã—Ç–∞–µ—Ç—Å—è –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
#   2. –ú–∏–≥—Ä–∞—Ü–∏–∏ ‚Äî –ø—Ä–∏–º–µ–Ω—è–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
#   3. –ó–∞–ø—É—Å–∫ ‚Äî —Å—Ç–∞—Ä—Ç—É–µ—Ç uvicorn —Å–µ—Ä–≤–µ—Ä
#
# –ü—Ä–∏ –æ—à–∏–±–∫–µ –Ω–∞ –ª—é–±–æ–º —ç—Ç–∞–ø–µ:
#   - –°–∫—Ä–∏–ø—Ç –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è (–±–ª–∞–≥–æ–¥–∞—Ä—è set -e)
#   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω LOGGING__TELEGRAM__CHAT_ID)
#   - –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–∞–¥–∞–µ—Ç ‚Äî Amvera –ø–æ–∫–∞–∂–µ—Ç –æ—à–∏–±–∫—É –≤ –ª–æ–≥–∞—Ö
#
# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:
#   BOT__TOKEN                  ‚Äî —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ (—É–∂–µ –µ—Å—Ç—å –¥–ª—è —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞)
#   LOGGING__TELEGRAM__CHAT_ID  ‚Äî Telegram ID –∞–¥–º–∏–Ω–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
#
# –ö–∞–∫ —É–∑–Ω–∞—Ç—å —Å–≤–æ–π Telegram ID:
#   1. –ù–∞–ø–∏—à–∏—Ç–µ –±–æ—Ç—É @userinfobot –≤ Telegram
#   2. –û–Ω –æ—Ç–≤–µ—Ç–∏—Ç –≤–∞—à–∏–º ID (—á–∏—Å–ª–æ –≤–∏–¥–∞ 123456789)
# ==============================================================================

# –ü—Ä–∏ –æ—à–∏–±–∫–µ –≤ –ª—é–±–æ–π –∫–æ–º–∞–Ω–¥–µ ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫—Ä–∏–ø—Ç
set -e

# ==============================================================================
# –§–£–ù–ö–¶–ò–Ø –≠–ö–†–ê–ù–ò–†–û–í–ê–ù–ò–Ø HTML
# ==============================================================================
#
# –≠–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã HTML –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –≤—Å—Ç–∞–≤–∫–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è.
# Telegram –∏—Å–ø–æ–ª—å–∑—É–µ—Ç HTML parse_mode, –ø–æ—ç—Ç–æ–º—É —Å–∏–º–≤–æ–ª—ã <, >, & –≤ —Ç–µ–∫—Å—Ç–µ –æ—à–∏–±–æ–∫
# (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ Python traceback: File "<string>") —Å–ª–æ–º–∞—é—Ç –ø–∞—Ä—Å–∏–Ω–≥.
#
# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
#   $1 ‚Äî —Ç–µ–∫—Å—Ç –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
#
# –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
#   –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ echo (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ $(...) –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞)
#
# –ü—Ä–∏–º–µ—Ä:
#   escaped=$(escape_html "File <stdin>")  # -> "File &lt;stdin&gt;"
# ==============================================================================
escape_html() {
    local text="$1"
    # –ü–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω: & –¥–æ–ª–∂–µ–Ω —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø–µ—Ä–≤—ã–º,
    # –∏–Ω–∞—á–µ &lt; –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—Å—è –≤ &amp;lt;
    text="${text//&/&amp;}"
    text="${text//</&lt;}"
    text="${text//>/&gt;}"
    echo "$text"
}

# ==============================================================================
# –§–£–ù–ö–¶–ò–Ø –û–¢–ü–†–ê–í–ö–ò –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø –í TELEGRAM
# ==============================================================================
#
# –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É —á–µ—Ä–µ–∑ Telegram Bot API.
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç curl –¥–ª—è HTTP-–∑–∞–ø—Ä–æ—Å–∞ –∫ api.telegram.org.
#
# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
#   $1 ‚Äî —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç emoji –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫)
#
# –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
#   - BOT__TOKEN ‚Äî —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞)
#   - LOGGING__TELEGRAM__CHAT_ID ‚Äî ID —á–∞—Ç–∞ –∞–¥–º–∏–Ω–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
#
# –ï—Å–ª–∏ LOGGING__TELEGRAM__CHAT_ID –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî —Ñ—É–Ω–∫—Ü–∏—è –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—Ç.
# –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –±–æ—Ç–∞ –±–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.
# ==============================================================================
send_telegram_notification() {
    local message="$1"

    # –ï—Å–ª–∏ ID –∞–¥–º–∏–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî –ø—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏–º –±–µ–∑ –æ—à–∏–±–∫–∏
    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã, –±–æ—Ç –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –∏ –±–µ–∑ –Ω–∏—Ö
    if [ -z "$LOGGING__TELEGRAM__CHAT_ID" ]; then
        echo "[–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è] LOGGING__TELEGRAM__CHAT_ID –Ω–µ —É–∫–∞–∑–∞–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É"
        return 0
    fi

    # –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    # –ù–æ –º—ã –Ω–µ –ø–∞–¥–∞–µ–º, –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
    if [ -z "$BOT__TOKEN" ]; then
        echo "[–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è] BOT__TOKEN –Ω–µ —É–∫–∞–∑–∞–Ω, –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
        return 0
    fi

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram Bot API
    # --silent ‚Äî –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏
    # --show-error ‚Äî –Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏
    # --max-time 10 ‚Äî —Ç–∞–π–º–∞—É—Ç 10 —Å–µ–∫—É–Ω–¥ (—á—Ç–æ–±—ã –Ω–µ –∑–∞–≤–∏—Å–Ω—É—Ç—å –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å —Å–µ—Ç—å—é)
    # parse_mode=HTML ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ <b>, <i>, <code> –≤ —Ç–µ–∫—Å—Ç–µ
    #
    # –ï—Å–ª–∏ curl –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è —Å –æ—à–∏–±–∫–æ–π ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º (|| true)
    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    curl --silent --show-error --max-time 10 \
        -X POST "https://api.telegram.org/bot${BOT__TOKEN}/sendMessage" \
        -d "chat_id=${LOGGING__TELEGRAM__CHAT_ID}" \
        -d "text=${message}" \
        -d "parse_mode=HTML" > /dev/null 2>&1 || true

    echo "[–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è] –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É"
}

# ==============================================================================
# –§–£–ù–ö–¶–ò–Ø –û–¢–ü–†–ê–í–ö–ò –§–ê–ô–õ–ê –í TELEGRAM
# ==============================================================================
#
# –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–∞–π–ª —Å –ø–æ–ª–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ.
#
# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
#   $1 ‚Äî —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞
#   $2 ‚Äî –∏–º—è —Ñ–∞–π–ª–∞
# ==============================================================================
send_telegram_file() {
    local content="$1"
    local filename="$2"

    if [ -z "$LOGGING__TELEGRAM__CHAT_ID" ] || [ -z "$BOT__TOKEN" ]; then
        return 0
    fi

    # –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    local tmpfile=$(mktemp)
    echo "$content" > "$tmpfile"

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª
    curl --silent --show-error --max-time 30 \
        -X POST "https://api.telegram.org/bot${BOT__TOKEN}/sendDocument" \
        -F "chat_id=${LOGGING__TELEGRAM__CHAT_ID}" \
        -F "document=@${tmpfile};filename=${filename}" > /dev/null 2>&1 || true

    # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    rm -f "$tmpfile"

    echo "[–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è] –û—Ç–ø—Ä–∞–≤–ª–µ–Ω —Ñ–∞–π–ª —Å –ø–æ–ª–Ω—ã–º –ª–æ–≥–æ–º"
}

# ==============================================================================
# –≠–¢–ê–ü 1: –ü–†–û–í–ï–†–ö–ê –ö–û–î–ê
# ==============================================================================
#
# –ü—ã—Ç–∞–µ–º—Å—è –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≥–ª–∞–≤–Ω—ã–π –º–æ–¥—É–ª—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
# –≠—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:
#   - –°–∏–Ω—Ç–∞–∫—Å–∏—Å Python-–∫–æ–¥–∞ (–Ω–µ—Ç SyntaxError)
#   - –í—Å–µ –∏–º–ø–æ—Ä—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç (–Ω–µ—Ç ImportError, ModuleNotFoundError)
#   - –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
#   - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–∞–ª–∏–¥–Ω–∞ (pydantic –ø—Ä–æ–≤–µ—Ä—è–µ—Ç .env –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ settings)
#
# –ï—Å–ª–∏ –∏–º–ø–æ—Ä—Ç —É–ø–∞–ª ‚Äî –∑–Ω–∞—á–∏—Ç –∫–æ–¥ —Ç–æ—á–Ω–æ –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è.
# –õ—É—á—à–µ —É–∑–Ω–∞—Ç—å –æ–± —ç—Ç–æ–º —Å—Ä–∞–∑—É, —á–µ–º –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π.
# ==============================================================================
echo "=== –≠—Ç–∞–ø 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ ==="
echo "–ü—ã—Ç–∞–µ–º—Å—è –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."

# –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã–≤–æ–¥–∞
import_log=$(mktemp)

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å –≤—ã–≤–æ–¥–æ–º –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ (—á–µ—Ä–µ–∑ tee)
# |& ‚Äî –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –∏ stdout, –∏ stderr –≤ pipe
# tee –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤—ã–≤–æ–¥ –∏ –≤ —Ñ–∞–π–ª, –∏ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
if ! python -c "from src.main import app; print('–ò–º–ø–æ—Ä—Ç —É—Å–ø–µ—à–µ–Ω')" |& tee "$import_log"; then
    echo ""
    echo "–û–®–ò–ë–ö–ê: –ö–æ–¥ –Ω–µ –ø—Ä–æ—à—ë–ª –ø—Ä–æ–≤–µ—Ä–∫—É!"

    import_error=$(cat "$import_log")
    error_length=${#import_error}

    if [ $error_length -gt 3500 ]; then
        # –û—à–∏–±–∫–∞ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–∞—è ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫—Ä–∞—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ —Ñ–∞–π–ª
        short_message="üö® <b>–û—à–∏–±–∫–∞ –¥–µ–ø–ª–æ—è: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞</b>

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ —Å–º–æ–≥–ª–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è.
–û—à–∏–±–∫–∞ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–∞—è ‚Äî –ø–æ–ª–Ω—ã–π –ª–æ–≥ –≤ —Ñ–∞–π–ª–µ –Ω–∏–∂–µ."

        send_telegram_notification "$short_message"
        send_telegram_file "$import_error" "deploy_error_import.txt"
    else
        # –û—à–∏–±–∫–∞ –∫–æ—Ä–æ—Ç–∫–∞—è ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç
        # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º HTML-—Å–∏–º–≤–æ–ª—ã –≤ —Ç–µ–∫—Å—Ç–µ –æ—à–∏–±–∫–∏, —Ç.–∫. traceback —Å–æ–¥–µ—Ä–∂–∏—Ç <, >
        # (–Ω–∞–ø—Ä–∏–º–µ—Ä, File "<string>") –∫–æ—Ç–æ—Ä—ã–µ —Å–ª–æ–º–∞—é—Ç parse_mode=HTML
        escaped_error=$(escape_html "$import_error")
        error_message="üö® <b>–û—à–∏–±–∫–∞ –¥–µ–ø–ª–æ—è: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞</b>

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ —Å–º–æ–≥–ª–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è.
–°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –µ—Å—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏.

<code>${escaped_error}</code>

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ Amvera –¥–ª—è –¥–µ—Ç–∞–ª–µ–π."

        send_telegram_notification "$error_message"
    fi

    rm -f "$import_log"
    exit 1
fi

rm -f "$import_log"
echo "‚úì –ö–æ–¥ –ø—Ä–æ—à—ë–ª –ø—Ä–æ–≤–µ—Ä–∫—É"
echo ""

# ==============================================================================
# –≠–¢–ê–ü 2: –ú–ò–ì–†–ê–¶–ò–ò –ë–ê–ó–´ –î–ê–ù–ù–´–•
# ==============================================================================
#
# –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Å–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ Alembic.
# "alembic upgrade head" ‚Äî –ø—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏.
#
# –ß—Ç–æ –º–æ–∂–µ—Ç –ø–æ–π—Ç–∏ –Ω–µ —Ç–∞–∫:
#   - –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (timeout)
#   - –ö–æ–Ω—Ñ–ª–∏–∫—Ç –º–∏–≥—Ä–∞—Ü–∏–π (–¥–≤–µ –≤–µ—Ç–∫–∏ —Å —Ä–∞–∑–Ω—ã–º–∏ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏)
#   - –û—à–∏–±–∫–∞ –≤ –∫–æ–¥–µ –º–∏–≥—Ä–∞—Ü–∏–∏
#   - –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ
#
# –ü—Ä–∏ –æ—à–∏–±–∫–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ù–ï –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è.
# –≠—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç —Å–∏—Ç—É–∞—Ü–∏–∏, –∫–æ–≥–¥–∞ –∫–æ–¥ –æ–∂–∏–¥–∞–µ—Ç –Ω–æ–≤—É—é —Å—Ö–µ–º—É –ë–î,
# –∞ –≤ –±–∞–∑–µ —Å—Ç–∞—Ä–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞.
#
# –í–ê–ñ–ù–û: –í—ã–≤–æ–¥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ —á–µ—Ä–µ–∑ tee.
# –¢–∞–π–º–∞—É—Ç 120 —Å–µ–∫—É–Ω–¥ ‚Äî –µ—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–∏—Å–ª–∞, –æ–Ω–∞ –±—É–¥–µ—Ç –ø—Ä–µ—Ä–≤–∞–Ω–∞.
# ==============================================================================
echo "=== –≠—Ç–∞–ø 2: –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö ==="
echo "–ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ (alembic upgrade head)..."
echo ""

# –¢–∞–π–º–∞—É—Ç –Ω–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö.
# –ï—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–∏—Å–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î) ‚Äî –ø—Ä–µ—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 120 —Å–µ–∫.
# –û–±—ã—á–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –∑–∞–Ω–∏–º–∞—é—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥, —Ç–∞–∫ —á—Ç–æ 120 —Å–µ–∫ ‚Äî —ç—Ç–æ –º–Ω–æ–≥–æ.
MIGRATION_TIMEOUT=120

# –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã–≤–æ–¥–∞
migration_log=$(mktemp)

# –ó–∞–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ —Å —Ç–∞–π–º–∞—É—Ç–æ–º –∏ –≤—ã–≤–æ–¥–æ–º –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
# timeout ‚Äî –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É –µ—Å–ª–∏ –æ–Ω–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–æ–ª—å—à–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
# |& tee ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—ã–≤–æ–¥ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –ò —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ —Ñ–∞–π–ª
if ! timeout ${MIGRATION_TIMEOUT} alembic upgrade head |& tee "$migration_log"; then
    exit_code=$?
    echo ""

    # –ö–æ–¥ 124 –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ timeout –ø—Ä–µ—Ä–≤–∞–ª –∫–æ–º–∞–Ω–¥—É
    if [ $exit_code -eq 124 ]; then
        echo "–û–®–ò–ë–ö–ê: –ú–∏–≥—Ä–∞—Ü–∏–∏ –∑–∞–≤–∏—Å–ª–∏ (—Ç–∞–π–º–∞—É—Ç ${MIGRATION_TIMEOUT} —Å–µ–∫)!"
        timeout_message="üö® <b>–û—à–∏–±–∫–∞ –¥–µ–ø–ª–æ—è: –º–∏–≥—Ä–∞—Ü–∏–∏ –∑–∞–≤–∏—Å–ª–∏</b>

–ú–∏–≥—Ä–∞—Ü–∏–∏ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å –∑–∞ ${MIGRATION_TIMEOUT} —Å–µ–∫—É–Ω–¥.
–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
‚Ä¢ –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
‚Ä¢ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞
‚Ä¢ –°–ª–∏—à–∫–æ–º –¥–æ–ª–≥–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
‚Ä¢ –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å PostgreSQL
‚Ä¢ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è DATABASE__*
‚Ä¢ –õ–æ–≥–∏ –≤ Amvera"

        send_telegram_notification "$timeout_message"
    else
        echo "–û–®–ò–ë–ö–ê: –ú–∏–≥—Ä–∞—Ü–∏–∏ –Ω–µ –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å!"

        migration_error=$(cat "$migration_log")
        error_length=${#migration_error}

        if [ $error_length -gt 3500 ]; then
            short_message="üö® <b>–û—à–∏–±–∫–∞ –¥–µ–ø–ª–æ—è: –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î</b>

–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏.
–û—à–∏–±–∫–∞ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–∞—è ‚Äî –ø–æ–ª–Ω—ã–π –ª–æ–≥ –≤ —Ñ–∞–π–ª–µ –Ω–∏–∂–µ."

            send_telegram_notification "$short_message"
            send_telegram_file "$migration_error" "deploy_error_migration.txt"
        else
            # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º HTML-—Å–∏–º–≤–æ–ª—ã –≤ —Ç–µ–∫—Å—Ç–µ –æ—à–∏–±–∫–∏
            escaped_error=$(escape_html "$migration_error")
            error_message="üö® <b>–û—à–∏–±–∫–∞ –¥–µ–ø–ª–æ—è: –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î</b>

–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
‚Ä¢ –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
‚Ä¢ –ö–æ–Ω—Ñ–ª–∏–∫—Ç –º–∏–≥—Ä–∞—Ü–∏–π
‚Ä¢ –û—à–∏–±–∫–∞ –≤ –∫–æ–¥–µ –º–∏–≥—Ä–∞—Ü–∏–∏

<code>${escaped_error}</code>

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ Amvera –¥–ª—è –¥–µ—Ç–∞–ª–µ–π."

            send_telegram_notification "$error_message"
        fi
    fi

    rm -f "$migration_log"
    exit 1
fi

rm -f "$migration_log"
echo ""
echo "‚úì –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"
echo ""

# ==============================================================================
# –≠–¢–ê–ü 3: –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
# ==============================================================================
#
# –ó–∞–ø—É—Å–∫–∞–µ–º uvicorn —Å –Ω–∞—à–∏–º FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.
#
# exec ‚Äî –∑–∞–º–µ–Ω—è–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å bash –Ω–∞ uvicorn.
# –≠—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤:
#   - SIGTERM –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —É–π–¥—ë—Ç –Ω–∞–ø—Ä—è–º—É—é –≤ uvicorn
#   - uvicorn –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç —Ä–∞–±–æ—Ç—É (graceful shutdown)
#   - –ë–µ–∑ exec —Å–∏–≥–Ω–∞–ª —É—à—ë–ª –±—ã –≤ bash, –∞ uvicorn –º–æ–≥ –±—ã –∑–∞–≤–∏—Å–Ω—É—Ç—å
#
# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã uvicorn:
#   --host 0.0.0.0 ‚Äî —Å–ª—É—à–∞—Ç—å –Ω–∞ –≤—Å–µ—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
#   --port 8000 ‚Äî –ø–æ—Ä—Ç, —É–∫–∞–∑–∞–Ω–Ω—ã–π –≤ amvera.yml (containerPort: 8000)
#   --proxy-headers ‚Äî –¥–æ–≤–µ—Ä—è—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º X-Forwarded-* –æ—Ç –ø—Ä–æ–∫—Å–∏
#   --forwarded-allow-ips="*" ‚Äî –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏ –æ—Ç –ª—é–±–æ–≥–æ IP –ø—Ä–æ–∫—Å–∏
#
# –í–ê–ñ–ù–û: --proxy-headers –∏ --forwarded-allow-ips –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´ –¥–ª—è —Ä–∞–±–æ—Ç—ã –∑–∞ –ø—Ä–æ–∫—Å–∏!
# Amvera (–∏ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ PaaS) –∏—Å–ø–æ–ª—å–∑—É—é—Ç reverse proxy –ø–µ—Ä–µ–¥ –≤–∞—à–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.
# –ë–µ–∑ —ç—Ç–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:
#   - –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã SQLAdmin –º–æ–≥—É—Ç –Ω–µ –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è
#   - URL-—ã –±—É–¥—É—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å HTTP –≤–º–µ—Å—Ç–æ HTTPS
#   - request.url.scheme –≤—Å–µ–≥–¥–∞ –±—É–¥–µ—Ç "http"
# ==============================================================================
echo "=== –≠—Ç–∞–ø 3: –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ==="
echo "–ó–∞–ø—É—Å–∫–∞–µ–º uvicorn..."
exec uvicorn src.main:app --host 0.0.0.0 --port 8000 --proxy-headers --forwarded-allow-ips="*"
