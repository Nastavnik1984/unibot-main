# Правила разработки

Инструкции для AI-ассистентов при работе с этим репозиторием.

## Проект

**Unibot** — Telegram-бот для AI-генерации контента.

**Python:** 3.11 (обязательная версия)

**Стек:** aiogram 3.x, FastAPI, SQLAlchemy (async), Alembic, pytest

**Зависимости:** `requirements.txt` (production), `requirements-dev.txt` (разработка и тесты)

---

## Виртуальное окружение (ОБЯЗАТЕЛЬНО)

**Все команды** (тесты, линтеры, запуск приложения) выполнять **только** в виртуальном окружении.

```bash
# Linux / macOS
source .venv/bin/activate

# Windows (CMD)
.venv\Scripts\activate.bat

# Windows (PowerShell)
.venv\Scripts\Activate.ps1
```

Проверка активации:
```bash
# Linux / macOS
which python  # Должен показать .venv/bin/python

# Windows
where python  # Должен показать .venv\Scripts\python.exe
```

**Запрещено:** запускать `pytest`, `ruff`, `mypy` или приложение без активированного venv.

---

## Структура проекта

```
src/
├── app/           # Точка входа FastAPI
├── api/           # HTTP endpoints
├── bot/
│   ├── handlers/  # Обработчики команд (без бизнес-логики!)
│   ├── keyboards/ # Клавиатуры
│   ├── middleware/
│   ├── states/    # FSM
│   └── static/    # Медиафайлы
├── config/        # settings.py, yaml_config.py
├── db/
│   ├── models/    # SQLAlchemy модели
│   └── repositories/  # CRUD операции
├── services/      # Бизнес-логика (независима от aiogram!)
├── providers/     # Внешние API (AI, платежи)
├── admin/         # SQLAdmin
├── scheduler/     # Фоновые задачи
├── core/          # Исключения, базовые классы
└── utils/         # Утилиты
```

**Ключевое правило:** `handlers/` вызывает `services/`, `services/` использует `repositories/` и `providers/`. Бизнес-логика только в `services/`.

---

## Логи и отладка

**Логи приложения:** `data/logs/app.log`

```bash
# Последние 50 строк лога
tail -50 data/logs/app.log

# Следить за логами в реальном времени
tail -f data/logs/app.log

# Поиск ошибок
grep "ERROR\|EXCEPTION" data/logs/app.log
```

**Формат лога:** `дата | уровень | модуль | сообщение`

---

## Порядок разработки (Workflow)

### 1. План
- Предложи **2 варианта** решения
- Выбери лучший и объясни почему
- Задавай вопросы, если что-то непонятно

### 2. Изменения
- Внеси одобренные изменения
- Используй MCP-инструменты для проверки документации библиотек
- Переиспользуй существующие паттерны проекта

### 3. Тесты
- Запусти тесты, убедись что всё работает
- Исправь ошибки в коде или в тестах

### 4. Ревью
- Проведи итоговое ревью как архитектор ПО
- Обращай внимание на недочёты в архитектуре
- Делай код расширяемым, используй SOLID

---

## Перед любыми изменениями

1. **Прочитать** релевантные файлы
2. **Найти** похожий код и переиспользовать паттерны
3. **Спросить** если требования неясны

**Запрещено:** менять код без его прочтения, выдумывать API.

---

## Dependency Injection

Внешние сервисы, конфиг, время — передавать параметрами:

```python
# ✅ Правильно
class AIService:
    def __init__(self, provider: AIProvider, billing: BillingService):
        self._provider = provider

# ❌ Запрещено
def send_message(text: str):
    bot = Bot(token=settings.TOKEN)  # Создание внутри функции
```

---

## Качество кода

- **Типизация** — аннотации для всех публичных функций
- **Имена** — самодокументируемые, без сокращений
- **Константы** — `UPPER_CASE` на уровне модуля, без магических значений
- **Async** — везде `async/await`, без блокирующих вызовов
- **Размер файла** — до 300 строк
- **Удалять** неиспользуемый код

**Запрещено:** `# noqa`, `type: ignore`, `Any` без обоснования.

---

## Тестирование

```bash
pytest -q              # Все тесты
pytest --cov=src       # С покрытием
```

### Изоляция тестов (КРИТИЧЕСКИ ВАЖНО)

Тесты должны быть **полностью изолированы** и воспроизводимы в любом окружении.

| Запрещено | Правильно |
|-----------|-----------|
| Читать `.env` и реальные переменные окружения | Передавать настройки через фикстуры |
| Делать реальные HTTP-запросы к API | Мокировать внешние сервисы (Telegram, OpenAI, платежи) |
| Подключаться к реальной БД | Использовать in-memory SQLite |
| Использовать `@patch` | Передавать моки через конструктор (DI) |

---

## Язык

- **Русский:** docstrings, комментарии, документация, сообщения бота
- **Английский:** названия переменных, функций, классов

Комментарии объясняют **ЗАЧЕМ**, а не только что:
```python
# Таймаут AI-провайдера. <10 сек — частые таймауты, >60 — долгое ожидание.
DEFAULT_TIMEOUT = 30
```

---

## Критические ограничения

| Действие | Правило |
|----------|---------|
| **Git** | Только по запросу пользователя. Никогда `git push` самостоятельно |
| **Миграции** | Только после согласования. Никогда `alembic upgrade/downgrade` |
| **Зависимости** | Добавлять только с разрешения |
| **Секреты** | Никогда в код, логи, промпты |

---

## Проверка качества

```bash
ruff check . --fix && ruff format . && mypy . && pytest
```

**Задача завершена** только когда все проверки проходят.
